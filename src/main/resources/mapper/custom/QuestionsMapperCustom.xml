<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.yltrcc.blog.mapper.custom.QuestionsMapperCustom">
	<sql id="whereQuestions">
	<where>1=1
	<if test="status != null">
		and Questions_status=#{status}
	</if>
	<if test="post != null">
	  and Questions_post=#{post}
	</if>
	</where>
	</sql>
	<sql id="whereQuestionsCustom">
	<where>1=1
	<if test="QuestionsStatus != null">
		and Questions_status=#{QuestionsStatus}
	</if>
	<if test="QuestionsPost != null">
	  and Questions_post=#{QuestionsPost}
	</if>
	</where>
	</sql>
	
	<select id="findPageQuestions"
            resultType="com.yltrcc.blog.model.domain.QuestionsCustom" parameterType="com.yltrcc.blog.model.domain.QuestionsCustom">
			SELECT
			ma.*,
			GROUP_CONCAT(distinct mc.category_name ) AS categorysName,
			GROUP_CONCAT(distinct mc.category_url ) AS categorysUrl,
			GROUP_CONCAT(distinct mt.tag_name ) AS tagsName,
			GROUP_CONCAT(distinct mt.tag_url ) AS tagsUrl
			FROM
			blog_Questions ma
			LEFT JOIN blog_Questions_category mac ON ma.id = mac.Questions_id
			LEFT JOIN blog_category mc ON mc.category_id = mac.category_id
			LEFT JOIN blog_Questions_tag mat ON ma.id = mat.Questions_id
			LEFT JOIN blog_tag mt ON mt.tag_id = mat.tag_id
			<include refid="whereQuestionsCustom"></include>
			GROUP BY
			ma.id ORDER BY Questions_updatetime DESC,Questions_newstime DESC
	</select>
	<select id="findAllQuestions"
		resultType="com.yltrcc.blog.model.domain.QuestionsCustom">
		SELECT * FROM blog_Questions a
		<include refid="whereQuestions"></include>
	</select>

	<select id="countByStatus" resultType="integer">
		SELECT COUNT(*) FROM blog_Questions
		<include refid="whereQuestions"></include>
	</select>

	<select id="getCounts" resultType="integer">
		SELECT COUNT(*) FROM qb_details where 1 = 1
	</select>
	
	<update id="updateStatus" parameterType="int">
	update blog_Questions set Questions_status=#{status} where id = #{id}
	</update>
	
	<select id="findByQuestionsId" resultType="com.yltrcc.blog.model.domain.Question" parameterType="Integer">
	SELECT
	a.id,
	a.user_id,
	a.article_content,
	a.article_content_md,
	a.article_newstime,
	a.article_summary,
	a.article_thumbnail,
	a.article_title,
	article_type,
	a.article_comment,
	a.article_url
FROM
	qb_details a

WHERE
	a.id = #{id}
	</select>
	
	<select id="findDateAndCount" resultType="com.yltrcc.blog.model.dto.ArchiveBo">
	select DATE_FORMAT(Questions_newstime, '%Y年%m月') as date, count(*) as count from blog_Questions
	where Questions_post = 'post' and Questions_status = 0
	group by date order by date desc
	</select>
	
	<select id="findRepeatByUrl" parameterType="String" resultType="Integer">
	SELECT COUNT(*) FROM blog_Questions WHERE Questions_url = #{QuestionsUrl}
	</select>
	<select id="findByQuestionsUrl" parameterType="String" resultType="com.yltrcc.blog.model.domain.QuestionsCustom">
		SELECT
			ma.*,
			GROUP_CONCAT(distinct mc.category_name ) AS categorysName,
			GROUP_CONCAT(distinct mc.category_url ) AS categorysUrl,
			GROUP_CONCAT(distinct mt.tag_name ) AS tagsName,
			GROUP_CONCAT(distinct mt.tag_url ) AS tagsUrl
			FROM
			blog_Questions ma
			LEFT JOIN blog_Questions_category mac ON ma.id = mac.Questions_id
			LEFT JOIN blog_category mc ON mc.category_id = mac.category_id
			LEFT JOIN blog_Questions_tag mat ON ma.id = mat.Questions_id
			LEFT JOIN blog_tag mt ON mt.tag_id = mat.tag_id
			WHERE Questions_url=#{QuestionsUrl}
			GROUP BY ma.id 
	</select>
	
	<select id="findArtileByCategory" resultType="com.yltrcc.blog.model.domain.QuestionsCustom">
	SELECT * FROM blog_Questions WHERE id in
	(SELECT Questions_id FROM blog_Questions_category WHERE
	category_id=(SELECT category_id FROM blog_category WHERE category_url=#{category.categoryUrl})) and Questions_status =#{status}
	</select>
	
	<select id="findArtileByTag" resultType="com.yltrcc.blog.model.domain.QuestionsCustom">
	SELECT * FROM blog_Questions WHERE id in
	(SELECT Questions_id FROM blog_Questions_tag WHERE
	tag_id=(SELECT tag_id FROM blog_tag WHERE tag_url=#{tag.tagUrl})) and Questions_status =#{status}
	</select>
</mapper>